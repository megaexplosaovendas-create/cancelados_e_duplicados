<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confer√™ncia Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 5px; width: 100%; font-weight: bold; }
        .btn-sync { background-color: #6f42c1; color: white; } /* Roxo GitHub */
        .btn-download { background-color: #007bff; color: white; }
        .btn-clear { background-color: #6c757d; color: white; }

        #dbStatus { margin: 10px 0; font-weight: bold; color: #555; }
        
        #result-box { 
            padding: 20px; margin: 20px 0; border-radius: 8px; color: white;
            font-size: 1.5rem; font-weight: bold; min-height: 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .small-text { font-size: 0.9rem; font-weight: normal; margin-top: 5px; }

        .bg-idle { background-color: #adb5bd; }
        .bg-ok { background-color: #28a745; }
        .bg-cancel { background-color: #dc3545; }
        .bg-dup { background-color: #ffc107; color: #333 !important; }

        #reader { width: 100%; border-radius: 8px; overflow: hidden; background: black; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85em; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì° Leitor Sincronizado</h2>

    <div>
        <div id="dbStatus">Banco de dados: Vazio ‚ùå</div>
        <button class="btn btn-sync" onclick="sincronizarDados()">üîÑ Baixar Planilha do GitHub</button>
    </div>

    <div id="result-box" class="bg-idle">Aguardando dados...</div>
    <div id="reader"></div>

    <div style="margin-top: 20px;">
        <button class="btn btn-download" onclick="downloadCSV()">üì• Baixar Bips do Dia</button>
        <button class="btn btn-clear" onclick="clearData()">üóëÔ∏è Limpar</button>
    </div>

    <h3>Hist√≥rico Local</h3>
    <table id="historyTable">
        <thead><tr><th>Rastreio</th><th>Status</th><th>Hora</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let cancelledDB = new Set();
    let sessionScans = JSON.parse(localStorage.getItem('scans_v1')) || [];
    let isLocked = false;
    // NOME DO ARQUIVO QUE VOC√ä VAI SUBIR NO GITHUB
    const NOME_ARQUIVO_EXCEL = "cancelados.xlsx"; 

    updateTable();

    // --- SONS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    // --- 1. SINCRONIZAR COM GITHUB ---
    async function sincronizarDados() {
        const statusEl = document.getElementById('dbStatus');
        statusEl.innerText = "Baixando dados do GitHub...";
        
        try {
            // Adiciona timestamp para evitar cache (sempre pega a vers√£o nova)
            const response = await fetch(NOME_ARQUIVO_EXCEL + '?v=' + new Date().getTime());
            
            if (!response.ok) throw new Error("Arquivo n√£o encontrado no GitHub!");

            const arrayBuffer = await response.arrayBuffer();
            const wb = XLSX.read(arrayBuffer, { type: 'array' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            cancelledDB.clear();
            let count = 0;
            data.forEach(row => {
                let code = row['N¬∫ de Rastreio'] || row['Rastreio'] || row['N¬∫ de Pedido da Plataforma'];
                if(code) { cancelledDB.add(String(code).trim()); count++; }
            });

            statusEl.innerText = `‚úÖ Banco Atualizado: ${count} pedidos!`;
            statusEl.style.color = "green";
            document.getElementById('result-box').innerText = "Pronto para ler";

        } catch (error) {
            console.error(error);
            statusEl.innerText = "Erro ao baixar: " + error.message;
            statusEl.style.color = "red";
            alert("N√£o encontrei o arquivo 'cancelados.xlsx' no reposit√≥rio do GitHub. Verifique se o nome est√° correto.");
        }
    }

    // --- 2. LEITURA ---
    function onScanSuccess(decodedText) {
        if (isLocked || cancelledDB.size === 0) {
            if(cancelledDB.size === 0) alert("Por favor, clique em 'Baixar Planilha' primeiro!");
            return;
        }

        isLocked = true;
        const code = String(decodedText).trim();
        let status = 'ok', msg = 'LIBERADO', css = 'bg-ok';

        const alreadyScanned = sessionScans.some(item => item.code === code);

        if (alreadyScanned) {
            status = 'dup'; msg = 'DUPLICADO'; css = 'bg-dup';
            playTone(600, 'square', 0.2); setTimeout(() => playTone(600, 'square', 0.2), 200);
        } else if (cancelledDB.has(code)) {
            status = 'cancel'; msg = 'CANCELADO!'; css = 'bg-cancel';
            playTone(150, 'sawtooth', 0.8);
            saveScan(code, 'cancel', msg);
        } else {
            playTone(1000, 'sine', 0.2);
            saveScan(code, 'ok', msg);
        }

        updateUI(css, msg, code);
        setTimeout(() => {
            isLocked = false;
            document.getElementById('result-box').className = "bg-idle";
            document.getElementById('result-box').innerHTML = "Pronto";
        }, 2500);
    }

    function updateUI(css, msg, code) {
        const box = document.getElementById('result-box');
        box.className = css;
        box.innerHTML = `<div>${msg}</div><div class="small-text">${code}</div>`;
    }

    // --- 3. FUN√á√ïES AUXILIARES ---
    function saveScan(code, status, msg) {
        const record = { code, status, msg, time: new Date().toLocaleTimeString() };
        sessionScans.unshift(record);
        localStorage.setItem('scans_v1', JSON.stringify(sessionScans));
        updateTable();
    }
    function updateTable() {
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML = sessionScans.map(item => 
            `<tr><td>${item.code}</td><td style="color:${item.status==='cancel'?'red':(item.status==='dup'?'orange':'green')}">${item.msg}</td><td>${item.time}</td></tr>`
        ).join('');
    }
    function downloadCSV() {
        let csvContent = "data:text/csv;charset=utf-8,Codigo,Status,Hora\n";
        sessionScans.forEach(row => csvContent += `${row.code},${row.msg},${row.time}\n`);
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "relatorio_bips.csv");
        document.body.appendChild(link);
        link.click();
    }
    function clearData() {
        if(confirm('Limpar hist√≥rico?')) {
            sessionScans = [];
            localStorage.removeItem('scans_v1');
            updateTable();
        }
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    
    // Tenta sincronizar automaticamente ao abrir
    window.onload = function() { setTimeout(sincronizarDados, 1000); };
</script>
</body>

</html>