<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confer√™ncia Pro - Log√≠stica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; text-align: center; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Dashboard de Contagem */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 8px; color: white; font-weight: bold; }
        .stat-total { background-color: #2c3e50; }
        .stat-ok { background-color: #27ae60; }
        .stat-cancel { background-color: #e74c3c; }
        .stat-dup { background-color: #f39c12; }
        .stat-val { block-size: 1.5rem; display: block; font-size: 1.8rem; }

        /* Inputs Motorista */
        .driver-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .driver-info input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 5px; font-weight: bold; transition: 0.3s; }
        .btn-sync { background-color: #6f42c1; color: white; width: 100%; }
        .btn-pdf { background-color: #e74c3c; color: white; flex: 1; }
        .btn-clear { background-color: #95a5a6; color: white; }

        #result-box { 
            padding: 20px; margin: 15px 0; border-radius: 8px; color: white;
            font-size: 1.5rem; font-weight: bold; min-height: 50px;
        }
        .bg-idle { background-color: #bdc3c7; }
        .bg-ok { background-color: #2ecc71; }
        .bg-cancel { background-color: #e74c3c; }
        .bg-dup { background-color: #f1c40f; color: #333; }

        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöö Controle de Expedi√ß√£o</h2>

    <div class="stats-grid">
        <div class="stat-card stat-total"><span id="count-total" class="stat-val">0</span>Total</div>
        <div class="stat-card stat-ok"><span id="count-ok" class="stat-val">0</span>OK</div>
        <div class="stat-card stat-cancel"><span id="count-cancel" class="stat-val">0</span>Cancel.</div>
        <div class="stat-card stat-dup"><span id="count-dup" class="stat-val">0</span>Dup.</div>
    </div>

    <button class="btn btn-sync" onclick="sincronizarDados()">üîÑ Sincronizar Cancelados (GitHub)</button>
    <div id="dbStatus" style="font-size: 0.8rem; margin-top: 5px;">Aguardando sincroniza√ß√£o...</div>

    <div id="result-box" class="bg-idle">Aguardando Leitura...</div>
    <div id="reader"></div>

    <div class="driver-info">
        <input type="text" id="motorista" placeholder="Nome do Motorista">
        <input type="text" id="cpf" placeholder="CPF">
        <input type="text" id="placa" placeholder="Placa do Ve√≠culo">
    </div>

    <div style="display: flex; gap: 10px;">
        <button class="btn btn-pdf" onclick="gerarPDF()">üìÑ Gerar PDF de Entrega</button>
        <button class="btn btn-clear" onclick="clearData()">üóëÔ∏è Limpar Tudo</button>
    </div>

    <h3>Hist√≥rico da Sess√£o</h3>
    <table id="historyTable">
        <thead><tr><th>Rastreio</th><th>Status</th><th>Hora</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let cancelledDB = new Set();
    let sessionScans = JSON.parse(localStorage.getItem('scans_v1')) || [];
    let isLocked = false;
    const NOME_ARQUIVO_EXCEL = "cancelados.xlsx"; 

    // Inicializa√ß√£o
    updateTable();
    updateStats();

    // --- SONS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    async function sincronizarDados() {
        const statusEl = document.getElementById('dbStatus');
        try {
            const response = await fetch(NOME_ARQUIVO_EXCEL + '?v=' + new Date().getTime());
            if (!response.ok) throw new Error("Arquivo n√£o encontrado!");
            const arrayBuffer = await response.arrayBuffer();
            const wb = XLSX.read(arrayBuffer, { type: 'array' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            cancelledDB.clear();
            data.forEach(row => {
                let code = row['N¬∫ de Rastreio'] || row['Rastreio'] || row['N¬∫ de Pedido da Plataforma'];
                if(code) cancelledDB.add(String(code).trim());
            });
            statusEl.innerText = `‚úÖ Base atualizada: ${cancelledDB.size} cancelados.`;
            statusEl.style.color = "green";
        } catch (e) {
            statusEl.innerText = "‚ùå Erro ao baixar planilha de cancelados.";
            statusEl.style.color = "red";
        }
    }

    function onScanSuccess(decodedText) {
        if (isLocked) return;
        isLocked = true;

        const code = String(decodedText).trim();
        let status = 'ok', msg = 'LIBERADO', css = 'bg-ok';

        const alreadyScanned = sessionScans.some(item => item.code === code && item.status !== 'dup');

        if (alreadyScanned) {
            status = 'dup'; msg = 'DUPLICADO'; css = 'bg-dup';
            playTone(600, 'square', 0.2);
        } else if (cancelledDB.has(code)) {
            status = 'cancel'; msg = 'CANCELADO!'; css = 'bg-cancel';
            playTone(150, 'sawtooth', 0.8);
        } else {
            playTone(1000, 'sine', 0.2);
        }

        saveScan(code, status, msg);
        updateUI(css, msg, code);

        setTimeout(() => {
            isLocked = false;
            document.getElementById('result-box').className = "bg-idle";
            document.getElementById('result-box').innerText = "Pronto para pr√≥xima leitura";
        }, 1500);
    }

    function saveScan(code, status, msg) {
        sessionScans.unshift({ code, status, msg, time: new Date().toLocaleTimeString(), date: new Date().toLocaleDateString() });
        localStorage.setItem('scans_v1', JSON.stringify(sessionScans));
        updateTable();
        updateStats();
    }

    function updateStats() {
        document.getElementById('count-total').innerText = sessionScans.filter(s => s.status !== 'dup').length;
        document.getElementById('count-ok').innerText = sessionScans.filter(s => s.status === 'ok').length;
        document.getElementById('count-cancel').innerText = sessionScans.filter(s => s.status === 'cancel').length;
        document.getElementById('count-dup').innerText = sessionScans.filter(s => s.status === 'dup').length;
    }

    function updateTable() {
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML = sessionScans.slice(0, 10).map(item => 
            `<tr><td>${item.code}</td><td style="color:${item.status==='cancel'?'red':(item.status==='dup'?'orange':'green')}">${item.msg}</td><td>${item.time}</td></tr>`
        ).join('');
    }

    function updateUI(css, msg, code) {
        const box = document.getElementById('result-box');
        box.className = css;
        box.innerHTML = `<div>${msg}</div><div style="font-size:0.8rem">${code}</div>`;
    }

    function clearData() {
        if(confirm('Isso apagar√° todo o hist√≥rico de bips. Confirma?')) {
            sessionScans = [];
            localStorage.removeItem('scans_v1');
            updateTable();
            updateStats();
        }
    }

    async function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const motorista = document.getElementById('motorista').value || "_____________________";
        const cpf = document.getElementById('cpf').value || "___________________";
        const placa = document.getElementById('placa').value || "_______________";
        const dataHoje = new Date().toLocaleDateString();

        // Cabe√ßalho
        doc.setFontSize(18);
        doc.text("Relat√≥rio de Romaneio e Confer√™ncia", 105, 20, { align: "center" });
        doc.setFontSize(10);
        doc.text(`Gerado em: ${dataHoje} √†s ${new Date().toLocaleTimeString()}`, 105, 27, { align: "center" });

        // Resumo
        const total = sessionScans.filter(s => s.status !== 'dup').length;
        const cancelados = sessionScans.filter(s => s.status === 'cancel').length;
        
        doc.autoTable({
            startY: 35,
            head: [['Descri√ß√£o', 'Quantidade']],
            body: [
                ['Total de Itens Liberados', total - cancelados],
                ['Total de Itens Cancelados', cancelados],
                ['Total Geral de Bips √önicos', total]
            ],
            theme: 'striped'
        });

        // Tabela de Itens
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['C√≥digo de Rastreio', 'Status', 'Hora']],
            body: sessionScans.map(item => [item.code, item.msg, item.time]),
            headStyles: { fillColor: [44, 62, 80] }
        });

        // P√°gina de Assinaturas (Adiciona nova p√°gina se a tabela for longa)
        const finalY = doc.lastAutoTable.finalY;
        if (finalY > 200) doc.addPage();
        
        const bottomY = 260;
        doc.setFontSize(11);
        doc.text(`S√£o Paulo, ${dataHoje.split('/')[0]} de ${new Date().toLocaleString('pt-br', {month: 'long'})} de ${new Date().getFullYear()}`, 20, bottomY - 30);
        
        doc.text("_____________________", 20, bottomY);
        doc.text("Estoque", 35, bottomY + 5);

        doc.text("_____________________", 80, bottomY);
        doc.text("Motorista", 95, bottomY + 5);
        doc.text(`Nome: ${motorista}`, 80, bottomY + 12);

        doc.text("___________________", 140, bottomY);
        doc.text("CPF", 155, bottomY + 5);
        doc.text(`Doc: ${cpf}`, 140, bottomY + 12);

        doc.text("_______________", 185, bottomY, {align: 'right'});
        doc.text("Placa", 175, bottomY + 5);
        doc.text(`Vei: ${placa}`, 185, bottomY + 12, {align: 'right'});

        doc.save(`romaneio_${dataHoje.replace(/\//g, '-')}.pdf`);
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScanSuccess);
    window.onload = () => setTimeout(sincronizarDados, 1000);
</script>
</body>
</html>