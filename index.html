<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confer√™ncia Pro - Log√≠stica Shopee</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background-color: #f4f7f6; text-align: center; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Dashboard de Contagem */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { padding: 15px; border-radius: 8px; color: white; font-weight: bold; }
        .stat-total { background-color: #2c3e50; }
        .stat-ok { background-color: #27ae60; }
        .stat-cancel { background-color: #e74c3c; }
        .stat-dup { background-color: #f39c12; }
        .stat-val { display: block; font-size: 1.8rem; margin-bottom: 5px; }

        /* Inputs Motorista */
        .driver-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .driver-info input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }

        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 5px; font-weight: bold; transition: 0.3s; }
        .btn-sync { background-color: #6f42c1; color: white; width: 100%; margin-bottom: 10px; }
        .btn-pdf { background-color: #e74c3c; color: white; flex: 2; }
        .btn-clear { background-color: #95a5a6; color: white; flex: 1; }

        #result-box { 
            padding: 20px; margin: 15px 0; border-radius: 8px; color: white;
            font-size: 1.6rem; font-weight: bold; min-height: 60px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .bg-idle { background-color: #bdc3c7; }
        .bg-ok { background-color: #2ecc71; }
        .bg-cancel { background-color: #e74c3c; }
        .bg-dup { background-color: #f1c40f; color: #333 !important; }

        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 20px; background: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì° Sistema de Confer√™ncia Shopee</h2>

    <div class="stats-grid">
        <div class="stat-card stat-total"><span id="count-total" class="stat-val">0</span>Total</div>
        <div class="stat-card stat-ok"><span id="count-ok" class="stat-val">0</span>Liberados</div>
        <div class="stat-card stat-cancel"><span id="count-cancel" class="stat-val">0</span>Cancel.</div>
        <div class="stat-card stat-dup"><span id="count-dup" class="stat-val">0</span>Repetidos</div>
    </div>

    <button class="btn btn-sync" onclick="sincronizarDados()">üîÑ Sincronizar Cancelados (GitHub)</button>
    <div id="dbStatus" style="font-size: 0.85rem; margin-bottom: 15px; font-weight: bold;">Verificando banco de dados...</div>

    <div id="result-box" class="bg-idle">Aguardando Leitura</div>
    <div id="reader"></div>

    <div class="driver-info">
        <input type="text" id="motorista" placeholder="Nome do Motorista">
        <input type="text" id="cpf" placeholder="CPF">
        <input type="text" id="placa" placeholder="Placa do Ve√≠culo">
    </div>

    <div style="display: flex; gap: 10px;">
        <button class="btn btn-pdf" onclick="gerarPDF()">üìÑ Gerar PDF e Finalizar</button>
        <button class="btn btn-clear" onclick="clearData()">üóëÔ∏è Limpar Sess√£o</button>
    </div>

    <h3 style="text-align: left; margin-top: 30px;">Hist√≥rico Recente</h3>
    <table id="historyTable">
        <thead><tr><th>C√≥digo/ID</th><th>Status</th><th>Hor√°rio</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let cancelledDB = new Set();
    let sessionScans = JSON.parse(localStorage.getItem('scans_v2')) || [];
    let isLocked = false;
    const NOME_ARQUIVO_EXCEL = "cancelados.xlsx"; 

    // Inicializa√ß√£o da UI
    updateTable();
    updateStats();

    // --- SONS DE FEEDBACK ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    // --- SINCRONIZA√á√ÉO COM A PLANILHA ---
    async function sincronizarDados() {
        const statusEl = document.getElementById('dbStatus');
        statusEl.innerText = "Sincronizando com GitHub...";
        
        try {
            const response = await fetch(NOME_ARQUIVO_EXCEL + '?v=' + new Date().getTime());
            if (!response.ok) throw new Error("Planilha n√£o encontrada no servidor!");

            const arrayBuffer = await response.arrayBuffer();
            const wb = XLSX.read(arrayBuffer, { type: 'array' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            cancelledDB.clear();
            data.forEach(row => {
                // Mapeia especificamente o "ID do pedido" do seu arquivo
                let code = row['ID do pedido'] || row['ID do Pedido'] || row['N¬∫ de Rastreio'] || row['Rastreio'];
                if(code) cancelledDB.add(String(code).trim().toUpperCase());
            });

            statusEl.innerText = `‚úÖ Sucesso: ${cancelledDB.size} pedidos cancelados carregados.`;
            statusEl.style.color = "green";
        } catch (e) {
            statusEl.innerText = "‚ùå Erro na sincroniza√ß√£o: " + e.message;
            statusEl.style.color = "red";
        }
    }

    // --- PROCESSO DE LEITURA (SCAN) ---
    function onScanSuccess(decodedText) {
        if (isLocked) return;
        isLocked = true;

        const code = String(decodedText).trim().toUpperCase();
        let status = 'ok', msg = 'LIBERADO', css = 'bg-ok';

        // Verifica se √© duplicado na sess√£o atual
        const alreadyScanned = sessionScans.some(item => item.code === code);

        if (alreadyScanned) {
            status = 'dup'; msg = 'REPETIDO'; css = 'bg-dup';
            playTone(600, 'square', 0.2);
        } 
        // Verifica se consta na lista de cancelados da sua planilha
        else if (cancelledDB.has(code)) {
            status = 'cancel'; msg = 'CANCELADO!'; css = 'bg-cancel';
            playTone(150, 'sawtooth', 0.8);
        } else {
            // Se for um rastreio (BR...) mas a planilha s√≥ tiver IDs, avisa o usu√°rio
            if (code.startsWith("BR") && cancelledDB.size > 0) {
                const firstKey = Array.from(cancelledDB)[0];
                if (!firstKey.startsWith("BR")) {
                    console.warn("Aten√ß√£o: Voc√™ bipou um Rastreio, mas a planilha parece conter apenas IDs.");
                }
            }
            playTone(1000, 'sine', 0.2);
        }

        saveScan(code, status, msg);
        updateUI(css, msg, code);

        setTimeout(() => {
            isLocked = false;
            document.getElementById('result-box').className = "bg-idle";
            document.getElementById('result-box').innerText = "Aguardando Leitura";
        }, 1800);
    }

    function saveScan(code, status, msg) {
        const now = new Date();
        sessionScans.unshift({ 
            code, 
            status, 
            msg, 
            time: now.toLocaleTimeString(), 
            date: now.toLocaleDateString() 
        });
        localStorage.setItem('scans_v2', JSON.stringify(sessionScans));
        updateTable();
        updateStats();
    }

    function updateStats() {
        document.getElementById('count-total').innerText = sessionScans.length;
        document.getElementById('count-ok').innerText = sessionScans.filter(s => s.status === 'ok').length;
        document.getElementById('count-cancel').innerText = sessionScans.filter(s => s.status === 'cancel').length;
        document.getElementById('count-dup').innerText = sessionScans.filter(s => s.status === 'dup').length;
    }

    function updateTable() {
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML = sessionScans.slice(0, 8).map(item => 
            `<tr>
                <td>${item.code}</td>
                <td style="font-weight:bold; color:${item.status==='cancel'?'red':(item.status==='dup'?'#f39c12':'green')}">${item.msg}</td>
                <td>${item.time}</td>
            </tr>`
        ).join('');
    }

    function updateUI(css, msg, code) {
        const box = document.getElementById('result-box');
        box.className = css;
        box.innerHTML = `<div>${msg}</div><div style="font-size:0.9rem; margin-top:5px;">${code}</div>`;
    }

    function clearData() {
        if(confirm('Deseja limpar todo o hist√≥rico desta confer√™ncia?')) {
            sessionScans = [];
            localStorage.removeItem('scans_v2');
            updateTable();
            updateStats();
        }
    }

    // --- GERA√á√ÉO DO RELAT√ìRIO PDF ---
    async function gerarPDF() {
        if (sessionScans.length === 0) {
            alert("N√£o h√° dados para gerar o relat√≥rio.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const motorista = document.getElementById('motorista').value || "N√ÉO INFORMADO";
        const cpf = document.getElementById('cpf').value || "N√ÉO INFORMADO";
        const placa = document.getElementById('placa').value || "N√ÉO INFORMADA";
        const dataHoje = new Date().toLocaleDateString();

        // Cabe√ßalho do Documento
        doc.setFontSize(16);
        doc.text("Relat√≥rio de Confer√™ncia de Carga - Shopee", 105, 20, { align: "center" });
        doc.setFontSize(10);
        doc.text(`Data: ${dataHoje} | Gerado em: ${new Date().toLocaleTimeString()}`, 105, 28, { align: "center" });

        // Tabela de Dados do Motorista
        doc.autoTable({
            startY: 35,
            head: [['Motorista', 'CPF', 'Placa do Ve√≠culo']],
            body: [[motorista, cpf, placa]],
            theme: 'grid',
            headStyles: { fillColor: [100, 100, 100] }
        });

        // Resumo Estat√≠stico
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 5,
            head: [['Liberados', 'Cancelados', 'Repetidos', 'Total Geral']],
            body: [[
                sessionScans.filter(s => s.status === 'ok').length,
                sessionScans.filter(s => s.status === 'cancel').length,
                sessionScans.filter(s => s.status === 'dup').length,
                sessionScans.length
            ]],
            theme: 'plain',
            styles: { fontSize: 12, halign: 'center', fontStyle: 'bold' }
        });

        // Tabela Detalhada de Itens
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['C√≥digo de Barras (ID/Rastreio)', 'Status Final', 'Hora']],
            body: sessionScans.map(item => [item.code, item.msg, item.time]),
            headStyles: { fillColor: [44, 62, 80] },
            alternateRowStyles: { fillColor: [245, 245, 245] }
        });

        // Rodap√© com Assinaturas (Garante que fique no fim ou em nova p√°gina)
        let finalY = doc.lastAutoTable.finalY + 30;
        if (finalY > 240) { doc.addPage(); finalY = 40; }

        doc.setFontSize(10);
        doc.text(`S√£o Paulo, ${dataHoje}`, 20, finalY);
        
        const sigLine = "__________________________";
        const sigY = finalY + 30;
        
        doc.text(sigLine, 20, sigY);
        doc.text("Respons√°vel Estoque", 20, sigY + 5);

        doc.text(sigLine, 80, sigY);
        doc.text("Motorista", 80, sigY + 5);

        doc.text(sigLine, 140, sigY);
        doc.text("Confer√™ncia CPF/Placa", 140, sigY + 5);

        doc.save(`conferencia_${dataHoje.replace(/\//g, '-')}.pdf`);
    }

    // Inicializa Scanner
    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 20, qrbox: { width: 250, height: 150 } }, 
        onScanSuccess
    );

    // Sincroniza automaticamente ao abrir a p√°gina
    window.onload = () => setTimeout(sincronizarDados, 1000);
</script>

</body>
</html>